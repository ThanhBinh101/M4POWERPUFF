<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3PowerPuff</title>
    {% load static %}
    <link rel="icon" type="image/x-icon" href="{%static 'logo.png'%}">

    <link rel="stylesheet" type ="text/css" href="{%static 'prescriptionpage.css'%}">

    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">

    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
    <header>
        <div class = "logo-name">
            <img src="{%static 'logo.png'%}" alt="">
            <a href='{% url 'mainpage' %}'>M3PowerPuff</a>
        </div>

        <ul class = "navlist">
            <li><a href="">Home</a></li>
            <li><a href="">Services</a></li>
            <li><a href="">Doctors</a></li>
            <li><a href="">About us</a></li>
            <li><a href="">Contact us</a></li>
        </ul>

        <button type="button" id="go-back" class="btn btn-primary" data-bs-toggle="modal">
            Return
        </button>

    </header>

    <section class = "displaybox">
        <div class = "searchbox">
            <h3>Prescription</h3>
            <div>
                <button type="button" class="collapsible">Medicine List</button>
                <div class="content">
                    <input type="text" id="myInputMedicine" onkeyup="myFunctionMedicine()" placeholder="Search for names..">
                        <div class="table-wrapper">
                            <table id="myTableMedicine">
                                <tr class="header">
                                    <th style="width:60%;">Name</th>
                                    <th style="width:20%;">Quantity</th>
                                    <th style="width:20%;">Action</th>
                                </tr>
                                {% for medicine in medicines%}
                                <tr>
                                    <td>{{ medicine.name }}</td>
                                    <td><input type="number" class="quantity-input" min="0"></td>
                                    <td><button onclick="addToMedicineInput(this)">Add</button></td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                </div>
            </div>
        </div>
        <div class = "medicinelist">
            <form method="POST" >
                <div class="mb-3">
                    <label for="prescriptDiagnose" class="form-label">Diagnose</label>
                    <textarea class="form-control" name="patientdiagnose" placeholder="" required row="1"></textarea>
                </div>
                <div class="mb-3">
                    <label for="prescriptDiagnose" class="form-label">Note</label>
                    <textarea class="form-control" name="patientdiagnose" placeholder="" row="3"></textarea>
                </div>
                <div class="table-wrapper">
                    <table id="selectedMedicineTable" name="patientmedicine" class="table table-bordered custom-table">
                        <thead>
                            <tr class="table-danger">
                                <th scope="col" style="width: 50%;">Medicine Name</th>
                                <th scope="col" style="width: 25%;">Quantity</th>
                                <th scope="col" style="width: 25%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
        
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
    </section>

</body>
<script>
    function myFunctionMedicine() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInputMedicine");
        filter = input.value.toUpperCase();
        table = document.getElementById("myTableMedicine");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[0];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

    var coll = document.getElementsByClassName("collapsible");
    var i;

    for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
        this.classList.toggle("active");
        var content = this.nextElementSibling;
        if (content.style.display === "block") {
        content.style.display = "none";
        } else {
        content.style.display = "block";
        }
    });
    }

    function addToMedicineInput(button) {
        var row = button.parentNode.parentNode;
        var name = row.cells[0].innerHTML;
        var quantityInput = row.querySelector('.quantity-input');
        var quantity = parseInt(quantityInput.value) || 1;
        if (quantity < 0) {
            alert('Quantity cannot be negative.');
            return;
        }

        var selectedMedicineTable = document.getElementById('selectedMedicineTable').getElementsByTagName('tbody')[0];
        var rows = selectedMedicineTable.getElementsByTagName('tr');
        var existingRow = null;
        for (var i = 0; i < rows.length; i++) {
            if (rows[i].cells[0].innerHTML === name) {
                existingRow = rows[i];
                break;
            }
        }

        if (existingRow) {
            var existingQuantity = parseInt(existingRow.cells[1].innerHTML);
            existingRow.cells[1].innerHTML = existingQuantity + quantity;
        } else {
            var newRow = selectedMedicineTable.insertRow(selectedMedicineTable.rows.length);
            newRow.className = 'table-danger';

            var nameCell = newRow.insertCell(0);
            nameCell.innerHTML = name;

            var quantityCell = newRow.insertCell(1);
            quantityCell.innerHTML = quantity;

            var actionCell = newRow.insertCell(2);
            var removeButton = document.createElement('button');
            removeButton.innerHTML = '<i class="ri-close-fill"></i>';
            removeButton.className = 'remove-button';
            removeButton.onclick = function() {
                selectedMedicineTable.removeChild(newRow);
            };
            actionCell.appendChild(removeButton);
        }

        quantityInput.value = '';
    }

</script>

</html>