<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3PowerPuff</title>
    {%load static%}
    <link rel="icon" type="image/x-icon" href="{%static 'logo.png'%}">

    <link rel="stylesheet" type ="text/css" href="{%static 'prescriptionpage.css'%}">

    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">

    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
    <header>
        <div class = "logo-name">
            <img src="{%static 'logo.png'%}" alt="">
            <a href='{% url 'mainpage' %}'>M3PowerPuff</a>
        </div>

        <ul class = "navlist">
            <li><a href="">Home</a></li>
            <li><a href="">Services</a></li>
            <li><a href="">Doctors</a></li>
            <li><a href="">About us</a></li>
            <li><a href="">Contact us</a></li>
        </ul>

        <button type="button" id="go-back" class="btn btn-primary" data-bs-toggle="modal">
            Return
        </button>

    </header>

    <section class = "displaybox">
        <div class = "searchbox">
            <h3>Prescription</h3>
            <div>
                <button type="button" class="collapsible">Patients List</button>
                <div class="content">
                    <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for names..">
                        <div class="table-wrapper">
                            <table id="myTable">
                                <tr class="header">
                                    <th style="width:60%;">Name</th>
                                    <th style="width:40%;">ID</th>
                                </tr>
                                {%for patient in patients%}
                                <tr>
                                    <td>{{ patient.name }}</td>
                                    <td>{{ patient.id }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                </div>
            </div>

            <div>
                <button type="button" class="collapsible">Medicine List</button>
                <div class="content">
                    <input type="text" id="myInputMedicine" onkeyup="myFunctionMedicine()" placeholder="Search for names..">
                        <div class="table-wrapper">
                            <table id="myTableMedicine">
                                <tr class="header">
                                    <th style="width:60%;">Name</th>
                                    <th style="width:20%;">Quantity</th>
                                    <th style="width:20%;">Action</th>
                                </tr>
                                {%for medicine in medicines%}
                                <tr>
                                    <td>{{medicine.name}}</td>
                                    <td><input type="number" class="quantity-input" min="0"></td>
                                    <td><button onclick="addToMedicineInput(this)">Add</button></td>
                                </tr>
                                {% endfor%}
                            </table>
                        </div>
                </div>
            </div>

        </div>
        <div class = "prescriptionForm">
            <form method="POST" > {% csrf_token %}
                <div class="mb-3">
                    <label for="prescriptPatID" class="form-label">Patient ID</label>
                    <input type="text" class="form-control" id="id" name="patientid" placeholder="" value="{{UpPatient.id}}" required>
                </div>
                <div class="mb-3">
                    <label for="prescriptName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="name" name="patientname" placeholder="" value="{{UpPatient.name}}" required>
                </div>
                <div class="mb-3">
                    <label for="prescriptDiagnose" class="form-label">Diagnose</label>
                    <input type="text" class="form-control" name="patientdiagnose" placeholder="" required>
                </div>
                <div class="mb-3">
                    <label for="prescriptDiagnose" class="form-label">Medicine</label>
                    <textarea class="form-control" id="medicine" name="patientmedicine" placeholder="" required rows="5"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
    </section>

</body>
<script>
    function myFunction() {
      // Declare variables
      var input, filter, table, tr, td, i, txtValue;
      input = document.getElementById("myInput");
      filter = input.value.toUpperCase();
      table = document.getElementById("myTable");
      tr = table.getElementsByTagName("tr");
    
      // Loop through all table rows, and hide those who don't match the search query
      for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[0];
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }

    function myFunctionMedicine() {
        // Declare variables
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInputMedicine");
        filter = input.value.toUpperCase();
        table = document.getElementById("myTableMedicine");
        tr = table.getElementsByTagName("tr");
      
        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[0];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

    var coll = document.getElementsByClassName("collapsible");
    var i;

    for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
        this.classList.toggle("active");
        var content = this.nextElementSibling;
        if (content.style.display === "block") {
        content.style.display = "none";
        } else {
        content.style.display = "block";
        }
    });
    }

    document.addEventListener("DOMContentLoaded", function() {
        var tableRows = document.querySelectorAll("#myTable tr:not(.header)");
    
        tableRows.forEach(function(row) {
            row.addEventListener("click", function() {
                var columns = row.querySelectorAll("td");
                var name = columns[0].textContent;
                var id = columns[1].textContent;
    
                document.getElementById("name").value = name;
                document.getElementById("id").value = id
            });
        });
    });

    function addToMedicineInput(button) {
        var row = button.parentNode.parentNode;
        var name = row.cells[0].textContent;
        var quantityInput = row.querySelector(".quantity-input");
        var quantity = quantityInput.value.trim(); // Trim to remove any whitespace
    
        // If quantity is empty or not a number, default to 1
        if (!quantity || isNaN(quantity)) {
            quantity = 1;
        }
    
        var medicineInput = document.getElementById("medicine");
        var currentValue = medicineInput.value;
    
        // Check if the medicine is already in the input
        var regex = new RegExp(name + "\\s*\\(\\d+\\)", "i");
        if (regex.test(currentValue)) {
            // Update the quantity of the existing medicine
            var updatedValue = currentValue.replace(regex, name + " (" + quantity + ")");
            medicineInput.value = updatedValue;
        } else {
            // Add the new medicine to the input
            medicineInput.value += (medicineInput.value ? ", " : "") + name + " (" + quantity + ")";
        }
    }

    document.getElementById("go-back").addEventListener("click", () => {
        history.back();
      });

</script>

</html>